<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Little Flower School — Online App</title>
  <link rel="icon" href="assets/img/logo.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap');

    /* --- Root Variables and Themes --- */
    :root {
      --bg: #0d1222;
      --card: #151b2e;
      --text: #e7eefc;
      --muted: #94a3b8;
      --accent: #5e72eb;
      --gradient-card: linear-gradient(145deg, #181f38, #11172a);
      --shadow-card: 0 10px 40px rgba(0, 0, 0, 0.25);
      --shadow-hover: 0 15px 50px rgba(0, 0, 0, 0.4);
    }

    [data-theme="light"] {
      --bg: #f2f5fc;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #3b82f6;
      --gradient-card: linear-gradient(145deg, #ffffff, #f7f9fd);
      --shadow-card: 0 10px 30px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 15px 40px rgba(0, 0, 0, 0.12);
    }

    /* --- Global and Base Styles --- */
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Outfit', 'Inter', system-ui, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    /* --- Layout and Structure --- */
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.5rem;
    }
    .row {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .hidden {
      display: none !important;
    }

    /* --- Top Bar and Navigation --- */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: var(--card);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      background: #fff;
      padding: 6px;
    }
    .brand-title {
      font-weight: 700;
    }
    .brand-sub {
      font-size: 12px;
      opacity: .9;
    }
    .drawer {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: 240px;
      background: var(--card);
      padding: 12px;
      box-shadow: 8px 0 30px rgba(0, 0, 0, 0.4);
      z-index: 60;
    }
    .closeBtn {
      float: right;
      background: none;
      border: 0;
      font-size: 18px;
      color: var(--text);
      cursor: pointer;
    }

    /* --- Cards and Components --- */
    .card {
      background: var(--gradient-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-card);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
    .hero {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .hero-right {
      width: 320px;
      flex-shrink: 0;
    }
    .auth-card input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
      color: inherit;
      font-size: 1rem;
      transition: border-color 0.3s ease, background 0.3s ease;
    }
    .auth-card input:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.05);
    }

    /* --- Buttons --- */
    .btn {
      font-weight: 600;
      padding: 10px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      border: none;
    }
    .btn.primary {
      background: linear-gradient(45deg, #5e72eb, #7c3aed);
      color: #fff;
      box-shadow: 0 4px 15px rgba(94, 114, 235, 0.4);
    }
    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(94, 114, 235, 0.6);
    }
    .btn.outline {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
    .btn.outline:hover {
      border-color: var(--accent);
    }
    .btn.icon {
      background: rgba(255, 255, 255, 0.06);
      border-radius: 8px;
      padding: 8px 10px;
    }

    /* --- Modules and Grid --- */
    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    .module {
      background: var(--card);
      border-radius: 16px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .module:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
      border-color: var(--accent);
    }
    .module h4 {
      margin-top: 0.5rem;
      font-weight: 500;
    }
    .module-backbar {
      padding: 8px 0;
    }

    /* --- Modal and Footer --- */
    .modal-root {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }
    .modal {
      background: var(--card);
      padding: 1.5rem;
      border-radius: 12px;
      max-width: 900px;
      width: 96%;
    }
    .footer {
      padding: 1.5rem;
      text-align: center;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .muted {
      color: var(--muted);
    }
    .small {
      font-size: 13px;
    }

    /* --- Media Queries (Refined) --- */
    @media(max-width: 1000px) {
      .modules-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
    }
    @media(max-width: 560px) {
      .modules-grid {
        flex-direction: column;
        align-items: stretch;
      }
      .hero-right {
        width: 100%;
      }
      .container {
        padding: 0 1rem;
        margin: 1rem auto;
      }
    }
  </style>
</head>
<body data-theme="dark">

  <header class="topbar">
    <div class="brand">
      <img id="logoImg" src="assets/img/logo.png" class="logo" alt="logo"/>
      <div>
        <div id="schoolName" class="brand-title">Little Flower School</div>
        <div class="brand-sub">Digital School • Students · Teachers · Admin</div>
      </div>
    </div>

    <div class="top-actions">
      <select id="themeSelect" title="Theme">
        <option value="dark">🌙 Dark</option>
        <option value="light">☀ Light</option>
      </select>
      <button id="btnMenu" class="icon">☰</button>
    </div>
  </header>

  <nav id="drawer" class="drawer hidden">
    <button id="closeDrawer" class="closeBtn">✕</button>
    <ul>
      <li><button data-nav="home">Home</button></li>
      <li><button data-nav="login">Login</button></li>
      <li><button data-nav="calendar">Calendar</button></li>
      <li><button data-nav="notices">Notices</button></li>
      <li><button data-nav="gallery">Gallery</button></li>
      <li><button data-nav="timetable">Timetable</button></li>
      <li><button data-nav="attendance">Attendance</button></li>
      <li><button data-nav="fees">Fees</button></li>
      <li><button data-nav="leaves">Leaves</button></li>
      <li><button data-nav="about">About</button></li>
    </ul>
    <div class="drawer-footer">
      <div class="muted">Developer: Shubham Arun Hajare</div>
      <div class="muted">Contact: 9022761401</div>
    </div>
  </nav>

  <main class="container" id="appRoot">

    <!-- Home -->
    <section id="home" class="screen">
      <div class="hero card">
        <div>
          <h1>Welcome to Little Flower School</h1>
          <p class="muted">Professional portal for Students, Teachers and Admin — powered by Supabase</p>
          <div class="hero-actions">
            <button id="primaryLogin" class="btn primary">Login</button>
            <button id="openCalendar" class="btn outline">School Calendar</button>
          </div>
        </div>
        <aside class="hero-right">
          <div class="card small">
            <div class="muted small">Next event</div>
            <div id="nextEvent">—</div>
          </div>
          <div class="card small" style="margin-top:10px">
            <div class="muted small">Latest notice</div>
            <div id="latestNotice">—</div>
          </div>
        </aside>
      </div>

      <div class="card modules-grid" id="homeModules"></div>
    </section>

    <!-- Login -->
    <section id="login" class="screen hidden">
      <div class="card auth-card">
        <h2>Login</h2>
        <div class="row">
          <label>User ID</label>
          <input id="loginId" placeholder="username or id"/>
        </div>
        <div class="row">
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="password"/>
        </div>
        <div class="row">
          <button id="btnLogin" class="btn primary">Login</button>
          <button id="btnBackHome" class="btn outline">Back</button>
        </div>
        <div class="muted small">For first-time use: admin / admin123 (if you ran SQL seeder)</div>
      </div>
    </section>

    <!-- Dashboard (role-based) -->
    <section id="dashboard" class="screen hidden">
      <div class="card dash-top">
        <div>
          <div class="muted">Dashboard</div>
          <h2 id="dashTitle">—</h2>
          <div id="dashRole" class="muted small">—</div>
        </div>
        <div class="dash-actions">
          <button id="btnBack" class="btn outline">Back</button>
          <button id="btnLogout" class="btn">Logout</button>
        </div>
      </div>

      <div id="dashModules" class="card modules-grid"></div>
      <div id="dashContent" class="card" style="margin-top:12px"></div>
    </section>

    <!-- Generic module container -->
    <section id="moduleView" class="screen hidden">
      <div id="moduleBackBar" class="module-backbar">
        <button id="moduleBackBtn" class="btn outline">← Back</button>
      </div>
      <div id="moduleContent" class="card"></div>
    </section>

    <!-- About -->
    <section id="about" class="screen hidden">
      <div class="card">
        <h3>About This App</h3>
        <p>This portal (Little Flower School) is built for demo & school use. Developer: Shubham Arun Hajare • Contact: 9022761401</p>
      </div>
    </section>

    <!-- modal root -->
    <div id="modalRoot" class="modal-root hidden"></div>

  </main>

  <footer class="footer muted">Little Flower School • Online App</footer>

  <!-- Supabase client + app logic -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // supabaseClient.js
    const SUPABASE_URL = "https://gnfrvwgpilhvknjfhmwx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZnJ2d2dwaWxodmtuamZobXd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNjA3OTMsImV4cCI6MjA3MjgzNjc5M30.Pq5zgWEyAd_cTDivICMGflFCGs1m0n4xZxye31vpMOs";
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // main.js
    (function() {
      const $ = sel => document.querySelector(sel);
      const show = el => el && el.classList.remove('hidden');
      const hide = el => el && el.classList.add('hidden');

      // Theme
      const themeSelect = $('#themeSelect');
      const savedTheme = localStorage.getItem('lfs_theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      themeSelect.value = savedTheme;
      themeSelect.addEventListener('change', e => {
        document.documentElement.setAttribute('data-theme', e.target.value);
        localStorage.setItem('lfs_theme', e.target.value);
      });

      // Drawer
      $('#btnMenu').addEventListener('click', () => $('#drawer').classList.toggle('hidden'));
      $('#closeDrawer').addEventListener('click', () => $('#drawer').classList.add('hidden'));
      document.querySelectorAll('#drawer [data-nav]').forEach(btn => {
        btn.addEventListener('click', () => navigate(btn.dataset.nav));
      });

      // home modules
      const modules = [
        { id: 'calendar', label: 'School Calendar' },
        { id: 'notices', label: 'Notification Board' },
        { id: 'gallery', label: 'Gallery' },
        { id: 'timetable', label: 'Timetable' },
        { id: 'attendance', label: 'Attendance' },
        { id: 'fees', label: 'Fees' },
        { id: 'leaves', label: 'Leaves' },
        { id: 'users', label: 'Users (Admin)' }
      ];
      const modulesGrid = $('#homeModules');
      modulesGrid.innerHTML = '';
      modules.forEach(m => {
        const d = document.createElement('div');
        d.className = 'module';
        d.innerHTML = `<div style="font-size:22px">🔹</div><h4>${m.label}</h4>`;
        d.addEventListener('click', () => openModule(m.id));
        modulesGrid.appendChild(d);
      });

      // navigation helpers
      function hideAllScreens() {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
      }

      function navigate(id) {
        hideAllScreens();
        show(document.getElementById(id));
        $('#drawer').classList.add('hidden');
      }
      window.navigate = navigate; // expose

      $('#primaryLogin').addEventListener('click', () => navigate('login'));
      $('#openCalendar').addEventListener('click', () => openModule('calendar'));
      $('#btnBackHome')?.addEventListener('click', () => navigate('home'));
      $('#btnBack')?.addEventListener('click', () => navigate('home'));
      $('#btnLogout')?.addEventListener('click', logout);

      // SESSION handling
      let SESSION = JSON.parse(localStorage.getItem('lfs_session') || 'null');
      async function logout() {
        SESSION = null;
        localStorage.removeItem('lfs_session');
        toast('Logged out');
        navigate('home');
      }

      async function renderAfterLogin() {
        if (!SESSION) return;
        $('#dashTitle').textContent = SESSION.name || SESSION.id;
        $('#dashRole').textContent = (SESSION.role || 'user').toUpperCase();
        // build dash modules according to role
        const container = $('#dashModules');
        container.innerHTML = '';
        const role = SESSION.role;
        const adminModules = ['users', 'attendance', 'fees', 'calendar', 'notices', 'gallery', 'timetable', 'leaves'];
        const teacherModules = ['attendance', 'timetable', 'notices', 'gallery', 'leaves'];
        const studentModules = ['attendance', 'timetable', 'notices', 'gallery', 'leaves', 'fees'];

        const use = role === 'admin' ? adminModules : (role === 'teacher' ? teacherModules : studentModules);
        use.forEach(mid => {
          const b = document.createElement('button');
          b.className = 'btn';
          b.textContent = mid.charAt(0).toUpperCase() + mid.slice(1);
          b.addEventListener('click', () => openModule(mid));
          container.appendChild(b);
        });

        navigate('dashboard');
      }

      // toast
      function toast(msg, ms = 2200) {
        let root = document.getElementById('toastRoot');
        if (!root) {
          root = document.createElement('div');
          root.id = 'toastRoot';
          document.body.appendChild(root);
        }
        root.innerHTML = `<div class="toast">${msg}</div>`;
        setTimeout(() => root.innerHTML = '', ms);
      }
      window.toast = toast;

      // Login actions
      $('#btnLogin').addEventListener('click', async () => {
        const id = $('#loginId').value.trim();
        const pwd = $('#loginPass').value;
        if (!id || !pwd) return toast('Enter ID & password');
        try {
          const { data, error } = await supabase.from('users').select('*').eq('username', id).limit(1);
          if (error) {
            console.error(error);
            toast('Login error');
            return;
          }
          if (!data || !data.length) {
            toast('User not found');
            return;
          }
          const u = data[0];
          if (u.password !== pwd) {
            toast('Incorrect password');
            return;
          }
          SESSION = { id: u.id || u.username, username: u.username, role: u.role, name: u.name || u.username };
          localStorage.setItem('lfs_session', JSON.stringify(SESSION));
          toast('Welcome ' + (u.name || u.username));
          renderAfterLogin();
        } catch (e) {
          console.error(e);
          toast('Login failed');
        }
      });

      // On load: check existing session
      if (SESSION && SESSION.username) {
        // verify user exists
        (async () => {
          try {
            const { data } = await supabase.from('users').select('*').eq('username', SESSION.username).limit(1);
            if (data && data.length) {
              renderAfterLogin();
            } else {
              localStorage.removeItem('lfs_session');
              SESSION = null;
            }
          } catch (e) {
            console.warn(e);
          }
        })();
      }

      // --- MODULES (Integrated into one file) ---

      // users.js
      window.moduleOpen_users = async function(ctx) {
        const { session } = ctx;
        if (!session || session.role !== 'admin') {
          toast('Admin only');
          return;
        }
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('moduleView').classList.remove('hidden');
        document.getElementById('moduleContent').innerHTML = `
          <h3>Users — Admin</h3>
          <div style="margin-top:8px"><button id="addUserBtn" class="btn primary">Add User</button></div>
          <div style="margin-top:12px"><table id="usersTable"><thead><tr><th>Username</th><th>Name</th><th>Role</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        `;

        async function load() {
          const res = await supabase.from('users').select('*').order('created_at', { ascending: false });
          const rows = (res.data || []).map(u => `<tr>
            <td>${escape(u.username)}</td><td>${escape(u.name || '—')}</td><td>${escape(u.role)}</td>
            <td>
              <button class="btn" onclick="editUser('${u.username}')">Edit</button>
              ${u.username === 'admin' ? '' : `<button class="btn" onclick="deleteUser('${u.username}')">Delete</button>`}
            </td></tr>`).join('');
          document.querySelector('#usersTable tbody').innerHTML = rows || `<tr><td colspan="4" class="muted">No users</td></tr>`;
        }

        document.getElementById('addUserBtn').onclick = async () => {
          const username = prompt('Username (id):');
          if (!username) return;
          const password = prompt('Password:', '123456');
          if (!password) return;
          const role = prompt('Role (admin/teacher/student):', 'student');
          if (!role) return;
          const name = prompt('Full name:', '');
          await supabase.from('users').insert([{ username, password, role, name }]);
          toast('User added');
          load();
        };

        window.editUser = async function(username) {
          const { data } = await supabase.from('users').select('*').eq('username', username).limit(1);
          if (!data || !data.length) return toast('Not found');
          const u = data[0];
          const name = prompt('Name:', u.name || '');
          if (name === null) return;
          const role = prompt('Role:', u.role || 'student');
          if (role === null) return;
          await supabase.from('users').update({ name, role }).eq('username', username);
          toast('Updated');
          load();
        };

        window.deleteUser = async function(username) {
          if (!confirm('Delete user ' + username + '?')) return;
          await supabase.from('users').delete().eq('username', username);
          toast('Deleted');
          load();
        };

        function escape(s) {
          return String(s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
        }
        await load();
      };

      // attendance.js
      window.moduleOpen_attendance = async function(ctx) {
        const session = ctx.session;
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('moduleView').classList.remove('hidden');
        document.getElementById('moduleContent').innerHTML = `<h3>Attendance</h3>
          <div id="attControls" class="row" style="margin-top:8px"></div>
          <div style="margin-top:12px"><table id="attTable"><thead><tr><th>Date</th><th>User</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>`;

        const ctrl = document.getElementById('attControls');
        ctrl.innerHTML = '';
        const dateInp = document.createElement('input');
        dateInp.type = 'date';
        ctrl.appendChild(dateInp);

        if (session && (session.role === 'admin' || session.role === 'teacher')) {
          const select = document.createElement('select');
          select.id = 'attUserSel';
          ctrl.appendChild(select);
          const statusSel = document.createElement('select');
          statusSel.innerHTML = `<option value="present">Present</option><option value="absent">Absent</option><option value="leave">Leave</option>`;
          ctrl.appendChild(statusSel);
          const btn = document.createElement('button');
          btn.className = 'btn primary';
          btn.textContent = 'Mark';
          btn.onclick = mark;
          ctrl.appendChild(btn);

          const { data: users } = await supabase.from('users').select('username,name,role').order('username');
          select.innerHTML = users.map(u => `<option value="${u.username}">${u.name || u.username} — ${u.role}</option>`).join('');
        } else if (session && session.role === 'student') {
          const note = document.createElement('div');
          note.className = 'muted';
          note.textContent = 'Students can view only. If absent please inform school.';
          ctrl.appendChild(note);
        } else {
          ctrl.appendChild(Object.assign(document.createElement('div'), { textContent: 'Login to manage/view attendance', className: 'muted' }));
        }

        async function mark() {
          const who = document.getElementById('attUserSel').value;
          const date = dateInp.value;
          const status = statusSel.value;
          if (!who || !date) return toast('Choose user & date');
          await supabase.from('attendance').insert([{ user_id: who, date, status }]);
          toast('Marked');
          load();
        }

        async function load() {
          const { data } = await supabase.from('attendance').select('*').order('date', { ascending: false }).limit(200);
          const rows = (data || []).map(a => `<tr>
            <td>${a.date}</td><td>${a.user_id}</td><td>${a.role || '—'}</td><td>${a.status}</td>
            <td>${session && session.role === 'admin' ? `<button class="btn" onclick="deleteAtt('${a.id}')">Delete</button>` : ''}</td>
          </tr>`).join('');
          document.querySelector('#attTable tbody').innerHTML = rows || `<tr><td colspan="5" class="muted">No attendance</td></tr>`;
        }

        window.deleteAtt = async function(id) {
          if (!confirm('Delete?')) return;
          await supabase.from('attendance').delete().eq('id', id);
          toast('Deleted');
          load();
        };

        await load();
      };

      // fees.js
      window.moduleOpen_fees = async function(ctx) {
        const session = ctx.session;
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('moduleView').classList.remove('hidden');
        document.getElementById('moduleContent').innerHTML = `<h3>Fees</h3>
          <div id="feesControls" class="row" style="margin-top:8px"></div>
          <div style="margin-top:12px"><table id="feesTable"><thead><tr><th>Student</th><th>Year</th><th>Total</th><th>Paid</th><th>Due</th><th>Actions</th></tr></thead><tbody></tbody></table></div>`;

        const ctrl = document.getElementById('feesControls');
        ctrl.innerHTML = '';
        if (session && session.role === 'admin') {
          const addBtn = document.createElement('button');
          addBtn.className = 'btn primary';
          addBtn.textContent = 'Add/Update Fees';
          addBtn.onclick = addFees;
          ctrl.appendChild(addBtn);
        } else {
          ctrl.appendChild(Object.assign(document.createElement('div'), { className: 'muted', textContent: 'Students: view only. Teachers: view only.' }));
        }

        async function addFees() {
          const student = prompt('Student username/id:');
          if (!student) return;
          const year = prompt('Year (e.g. 2025):', '2025');
          if (!year) return;
          const total = parseFloat(prompt('Total amount:', '0')) || 0;
          const paid = parseFloat(prompt('Paid amount:', '0')) || 0;
          const due = total - paid;
          await supabase.from('fees').insert([{ student_id: student, year, total, paid, remaining: due }]);
          toast('Saved');
          load();
        }

        async function load() {
          const { data } = await supabase.from('fees').select('*').order('year', { ascending: false });
          const rows = (data || []).map(f => `<tr><td>${f.student_id}</td><td>${f.year}</td><td>${f.total}</td><td>${f.paid}</td><td>${f.remaining}</td>
            <td>${session && session.role === 'admin' ? `<button class="btn" onclick="deleteFee('${f.id}')">Delete</button>` : ''}</td></tr>`).join('');
          document.querySelector('#feesTable tbody').innerHTML = rows || `<tr><td colspan="6" class="muted">No fees</td></tr>`;
        }
        window.deleteFee = async function(id) {
          if (!confirm('Delete?')) return;
          await supabase.from('fees').delete().eq('id', id);
          toast('Deleted');
          load();
        };
        await load();
      };

      // leaves.js
      window.moduleOpen_leaves = async function(ctx) {
        const session = ctx.session;
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('moduleView').classList.remove('hidden');
        document.getElementById('moduleContent').innerHTML = `<h3>Leave Applications</h3>
          <div id="leaveControls" style="margin-top:8px"></div>
          <div style="margin-top:12px"><table id="leavesTable"><thead><tr><th>User</th><th>From</th><th>To</th><th>Reason</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table></div>`;
        const ctrl = document.getElementById('leaveControls');
        ctrl.innerHTML = '';
        if (session) {
          const applyBtn = document.createElement('button');
          applyBtn.className = 'btn primary';
          applyBtn.textContent = 'Apply Leave';
          applyBtn.onclick = apply;
          ctrl.appendChild(applyBtn);
        } else {
          ctrl.appendChild(Object.assign(document.createElement('div'), { className: 'muted', textContent: 'Login to apply leave.' }));
        }

        async function apply() {
          const from = prompt('From date (YYYY-MM-DD):');
          if (!from) return;
          const to = prompt('To date (YYYY-MM-DD):', from);
          if (!to) return;
          const reason = prompt('Reason (sick/outof town/family/other):', 'sick') || 'other';
          await supabase.from('leaves').insert([{ user_id: session.username, from_date: from, to_date: to, reason, status: 'pending' }]);
          toast('Applied');
          load();
        }

        async function load() {
          const { data } = await supabase.from('leaves').select('*').order('created_at', { ascending: false });
          const rows = (data || []).map(l => `<tr>
            <td>${l.user_id}</td><td>${l.from_date}</td><td>${l.to_date}</td><td>${l.reason}</td><td>${l.status}</td>
            <td>${session && session.role === 'admin' ? `<button class="btn" onclick="approveLeave('${l.id}')">Approve</button><button class="btn" onclick="rejectLeave('${l.id}')">Reject</button>` : ''}</td>
          </tr>`).join('');
          document.querySelector('#leavesTable tbody').innerHTML = rows || `<tr><td colspan="6" class="muted">No leaves</td></tr>`;
        }
        window.approveLeave = async function(id) {
          await supabase.from('leaves').update({ status: 'approved' }).eq('id', id);
          toast('Approved');
          load();
        };
        window.rejectLeave = async function(id) {
          await supabase.from('leaves').update({ status: 'rejected' }).eq('id', id);
          toast('Rejected');
          load();
        };
        await load();
      };

      // gallery.js
      window.moduleOpen_gallery = async function(ctx) {
        const session = ctx.session;
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('moduleView').classList.remove('hidden');
        document.getElementById('moduleContent').innerHTML = `<h3>Gallery</h3>
          <div id="galleryControls" style="margin-top:8px"></div>
          <div id="galleryList" style="margin-top:12px" class="row"></div>`;

        const ctrl = document.getElementById('galleryControls');
        ctrl.innerHTML = '';
        if (session && session.role === 'admin') {
          const addBtn = document.createElement('button');
          addBtn.className = 'btn primary';
          addBtn.textContent = 'Add Link';
          addBtn.onclick = add;
          ctrl.appendChild(addBtn);
        } else {
          ctrl.appendChild(Object.assign(document.createElement('div'), { className: 'muted', textContent: 'Gallery is read-only for non-admins.' }));
        }

        async function add() {
          const title = prompt('Title:');
          if (!title) return;
          const link = prompt('Google Drive / YouTube link:');
          if (!link) return;
          const category = prompt('Category:', 'Event') || 'Event';
          await supabase.from('gallery').insert([{ title, link, category }]);
          toast('Added');
          load();
        }
        async function load() {
          const { data } = await supabase.from('gallery').select('*').order('created_at', { ascending: false });
          const html = (data || []).map(g => `<div style="width:240px" class="card">
            <div style="font-weight:700">${g.title}</div>
            <div class="muted small">${g.category}</div>
            <div style="margin-top:8px"><a href="${g.link}" target="_blank" class="btn">Open</a> ${session && session.role === 'admin' ? `<button class="btn" onclick="deleteGallery('${g.id}')">Delete</button>` : ''}</div>
          </div>`).join('');
          document.getElementById('galleryList').innerHTML = html || `<div class="muted">No items</div>`;
        }
        window.deleteGallery = async function(id) {
          if (!confirm('Delete?')) return;
          await supabase.from('gallery').delete().eq('id', id);
          toast('Deleted');
          load();
        };
        await load();
      };

      // timetable.js
      window.moduleOpen_timetable = async function(ctx) {
        const session = ctx.session;
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('moduleView').classList.remove('hidden');
        document.getElementById('moduleContent').innerHTML = `<h3>Timetable</h3>
          <div id="ttControls" style="margin-top:8px"></div>
          <div id="ttList" style="margin-top:12px"></div>`;

        const ctrl = document.getElementById('ttControls');
        ctrl.innerHTML = '';
        if (session && session.role === 'admin') {
          const addBtn = document.createElement('button');
          addBtn.className = 'btn primary';
          addBtn.textContent = 'Add Entry';
          addBtn.onclick = add;
          ctrl.appendChild(addBtn);
        } else {
          ctrl.appendChild(Object.assign(document.createElement('div'), { className: 'muted', textContent: 'View only for non-admins.' }));
        }

        async function add() {
          const className = prompt('Class (e.g. 5th):');
          if (!className) return;
          const period = prompt('Period number (1-6):');
          if (!period) return;
          const subject = prompt('Subject:');
          if (!subject) return;
          const teacher = prompt('Teacher name:');
          if (!teacher) return;
          await supabase.from('timetable').insert([{ class: className, period, subject, teacher }]);
          toast('Saved');
          load();
        }

        async function load() {
          const { data } = await supabase.from('timetable').select('*').order('class', { ascending: true });
          if (!data || !data.length) {
            document.getElementById('ttList').innerHTML = '<div class="muted">No timetable entries</div>';
            return;
          }
          const html = data.map(r => `<div class="card"><strong>${r.class} — Period ${r.period}</strong><div>${r.subject} • ${r.teacher}</div>
            ${session && session.role === 'admin' ? `<div style="margin-top:6px"><button class="btn" onclick="deleteTT('${r.id}')">Delete</button></div>` : ''}
          </div>`).join('');
          document.getElementById('ttList').innerHTML = html;
        }

        window.deleteTT = async function(id) {
          if (!confirm('Delete?')) return;
          await supabase.from('timetable').delete().eq('id', id);
          toast('Deleted');
          load();
        };
        await load();
      };

      // modules/calendar.js
import { supabase } from '../assets/js/supabaseClient.js';

const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

export const calendarModule = {
  async render({root, session}){
    root.innerHTML = '<h3>School Calendar</h3><div id="calControls" style="display:flex;gap:8px;align-items:center;margin:10px 0"></div><div id="calRoot"></div>';
    const calRoot = root.querySelector('#calRoot');
    const controls = root.querySelector('#calControls');

    // month/year controls
    const now = new Date();
    let curMonth = now.getMonth();
    let curYear = now.getFullYear();

    function buildControls(){
      controls.innerHTML = `
        <button id="prev" class="btn outline">◀</button>
        <div style="font-weight:700;margin:0 8px">${MONTH_NAMES[curMonth]} ${curYear}</div>
        <button id="next" class="btn outline">▶</button>
        <select id="yearSelect" class="btn outline" style="margin-left:8px"></select>
      `;
      const ys = controls.querySelector('#yearSelect');
      for(let y=2024;y<=2028;y++){
        const o = document.createElement('option'); o.value=y; o.textContent=y; if(y===curYear) o.selected=true; ys.appendChild(o);
      }
      controls.querySelector('#prev').onclick = ()=> { curMonth--; if(curMonth<0){ curMonth=11; curYear--; } render(); };
      controls.querySelector('#next').onclick = ()=> { curMonth++; if(curMonth>11){ curMonth=0; curYear++; } render(); };
      ys.onchange = ()=> { curYear = Number(ys.value); render(); };
    }

    async function fetchEvents(month, year){
      try {
        // stored events in calendar_events table: date is TEXT or DATE in YYYY-MM-DD
        const start = `${year}-${String(month+1).padStart(2,'0')}-01`;
        const { data } = await supabase.from('calendar_events').select('*').gte('date', `${year}-${String(month+1).padStart(2,'0')}-01`).lte('date', `${year}-${String(month+1).padStart(2,'0')}-31`);
        return data || [];
      } catch(e){ console.error(e); return []; }
    }

    async function render(){
      buildControls();
      calRoot.innerHTML = '';
      const events = await fetchEvents(curMonth, curYear);
      const firstDay = new Date(curYear, curMonth, 1).getDay(); // 0 Sun..6
      const days = new Date(curYear, curMonth+1, 0).getDate();
      const grid = document.createElement('div'); grid.className='calendar-grid';
      // pad blanks until firstDay (assuming week starts Sun)
      for(let i=0;i<firstDay;i++){
        const blank = document.createElement('div'); blank.className='calendar-day'; blank.innerHTML = `<div style="opacity:.2"> </div>`; grid.appendChild(blank);
      }
      for(let d=1; d<=days; d++){
        const dayDiv = document.createElement('div'); dayDiv.className='calendar-day';
        const dd = `${curYear}-${String(curMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayEvents = events.filter(ev=> ev.date === dd);
        dayDiv.innerHTML = `<div class="date-num">${d}</div>`;
        dayEvents.forEach(ev=>{
          const el = document.createElement('div'); el.className='badge'; el.textContent = ev.title;
          el.style.marginTop = '6px';
          el.onclick = ()=> showEvent(ev);
          dayDiv.appendChild(el);
        });
        grid.appendChild(dayDiv);
      }
      calRoot.appendChild(grid);
    }

    function showEvent(ev){
      const cont = document.createElement('div');
      cont.innerHTML = `<h4>${ev.title}</h4><div class="muted small">${ev.date}</div><p style="margin-top:8px">${ev.description||''}</p>`;
      const modalRoot = document.getElementById('modalRoot');
      modalRoot.classList.remove('hidden');
      modalRoot.innerHTML = `<div class="card">${cont.outerHTML}<div style="text-align:right;margin-top:12px"><button id="closeEv" class="btn">Close</button></div></div>`;
      document.getElementById('closeEv').onclick = ()=> { modalRoot.classList.add('hidden'); modalRoot.innerHTML=''; };
    }

    await render();
  }
};

window.calendarModule = calendarModule;

        

      // expose logout for other modules
      window.APP = { getSession: () => SESSION, setSession: s => { SESSION = s; localStorage.setItem('lfs_session', JSON.stringify(s)); renderAfterLogin(); } };

      // initial populate home highlights & nextEvent
      (async function loadHome() {
        try {
          const { data: evs } = await supabase.from('calendar_events').select('*').order('date', { ascending: true }).limit(5);
          if (evs && evs.length) {
            $('#nextEvent').textContent = evs[0].title + ' • ' + evs[0].date;
            $('#latestNotice').textContent = (await supabase.from('notices').select('*').order('date', { ascending: false }).limit(1)).data?.[0]?.title || '—';
          }
        } catch (e) {
          console.warn(e);
        }
      })();

    })();
  </script>
</body>
</html>

